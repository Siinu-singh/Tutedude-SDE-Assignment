{% extends "base.html" %}

{% block title %}Tutedude - Analytics Dashboard{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="text-center mb-5">
    <div class="feature-icon mx-auto mb-3">
        <i class="fas fa-chart-line"></i>
    </div>
    <h2 class="text-white fw-bold mb-3">Analytics Dashboard</h2>
    <p class="text-white-50">Comprehensive insights and reports from AI-proctored interviews</p>
    <a href="{{ url_for('main.start_interview') }}" class="btn btn-primary btn-lg">
        <i class="fas fa-plus me-2"></i>New Interview
    </a>
</div>

{% if interviews %}
<!-- Statistics Cards -->
<div class="row g-4 mb-5">
    <div class="col-md-3">
        <div class="stats-card">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <h3 class="fw-bold mb-1">{{ interviews|length }}</h3>
                    <p class="mb-0 opacity-75">Total Interviews</p>
                </div>
                <i class="fas fa-users fa-2x opacity-75"></i>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <h3 class="fw-bold mb-1">{{ interviews|selectattr('status', 'equalto', 'completed')|list|length }}</h3>
                    <p class="mb-0 opacity-75">Completed</p>
                </div>
                <i class="fas fa-check-circle fa-2x opacity-75"></i>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <h3 class="fw-bold mb-1">{{ interviews|selectattr('status', 'equalto', 'active')|list|length }}</h3>
                    <p class="mb-0 opacity-75">Active</p>
                </div>
                <i class="fas fa-play-circle fa-2x opacity-75"></i>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    {% set completed_interviews = interviews|selectattr('status', 'equalto', 'completed')|selectattr('integrity_score', 'defined')|list %}
                    <h3 class="fw-bold mb-1">
                        {% if completed_interviews %}
                            {{ "%.0f"|format(completed_interviews|sum(attribute='integrity_score') / completed_interviews|length) }}%
                        {% else %}
                            -
                        {% endif %}
                    </h3>
                    <p class="mb-0 opacity-75">Avg. Score</p>
                </div>
                <i class="fas fa-chart-line fa-2x opacity-75"></i>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body p-0">
        <div class="d-flex align-items-center justify-content-between p-4 border-bottom">
            <h5 class="fw-bold mb-0">
                <i class="fas fa-list text-primary me-2"></i>Recent Interviews
            </h5>
            <span class="badge bg-primary">{{ interviews|length }} Total</span>
        </div>
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="fw-semibold">Candidate</th>
                        <th class="fw-semibold">Interviewer</th>
                        <th class="fw-semibold">Date & Time</th>
                        <th class="fw-semibold">Duration</th>
                        <th class="fw-semibold">Status</th>
                        <th class="fw-semibold">Integrity Score</th>
                        <th class="fw-semibold">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for interview in interviews %}
                    <tr>
                        <td>
                            <div>
                                <strong>{{ interview.candidate.name }}</strong>
                                <br>
                                <small class="text-muted">{{ interview.candidate.email }}</small>
                            </div>
                        </td>
                        <td>{{ interview.interviewer_name }}</td>
                        <td>
                            <div>
                                {{ interview.start_time.strftime('%b %d, %Y') }}
                                <br>
                                <small class="text-muted">{{ interview.start_time.strftime('%I:%M %p') }}</small>
                            </div>
                        </td>
                        <td>
                            {% if interview.duration %}
                                {{ interview.duration_formatted }}
                            {% else %}
                                <span class="text-muted">In progress</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if interview.status == 'completed' %}
                                <span class="badge bg-success">Completed</span>
                            {% elif interview.status == 'active' %}
                                <span class="badge bg-primary">Active</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ interview.status.title() }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if interview.integrity_score is not none %}
                                <div class="d-flex align-items-center">
                                    <div class="progress me-2" style="width: 60px; height: 8px;">
                                        <div class="progress-bar 
                                            {% if interview.integrity_score >= 80 %}bg-success
                                            {% elif interview.integrity_score >= 60 %}bg-warning
                                            {% else %}bg-danger{% endif %}" 
                                            style="width: {{ interview.integrity_score }}%"></div>
                                    </div>
                                    <span class="
                                        {% if interview.integrity_score >= 80 %}text-success
                                        {% elif interview.integrity_score >= 60 %}text-warning
                                        {% else %}text-danger{% endif %}">
                                        {{ "%.0f"|format(interview.integrity_score) }}%
                                    </span>
                                </div>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                {% if interview.status == 'completed' %}
                                    <a href="{{ url_for('main.generate_report', interview_id=interview.id) }}" 
                                       class="btn btn-outline-primary" title="View Report">
                                        <i class="fas fa-file-alt"></i>
                                    </a>
                                    <a href="{{ url_for('main.download_report', interview_id=interview.id) }}" 
                                       class="btn btn-outline-success" title="Download CSV">
                                        <i class="fas fa-download"></i>
                                    </a>
                                {% elif interview.status == 'active' %}
                                    <a href="{{ url_for('main.resume_interview', interview_id=interview.id) }}" 
                                       class="btn btn-outline-warning" title="Resume Interview">
                                        <i class="fas fa-play"></i>
                                    </a>
                                    <a href="{{ url_for('main.interview_room', interview_id=interview.id) }}" 
                                       class="btn btn-outline-primary" title="Monitor">
                                        <i class="fas fa-video"></i>
                                    </a>
                                {% else %}
                                    <button class="btn btn-outline-secondary" disabled title="Interview in progress">
                                        <i class="fas fa-clock"></i>
                                    </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% else %}
<div class="card">
    <div class="card-body text-center py-5">
        <div class="feature-icon mx-auto mb-4" style="background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%); color: #6b7280;">
            <i class="fas fa-clipboard-list"></i>
        </div>
        <h4 class="fw-bold mb-3">No Interviews Yet</h4>
        <p class="text-muted mb-4">Start your first AI-proctored interview session to see comprehensive analytics and insights here.</p>
        <a href="{{ url_for('main.start_interview') }}" class="btn btn-primary btn-lg">
            <i class="fas fa-play me-2"></i>Start First Interview
        </a>
        
        <div class="row g-3 mt-4">
            <div class="col-md-4">
                <div class="d-flex align-items-center justify-content-center">
                    <i class="fas fa-eye text-primary me-2"></i>
                    <small class="text-muted">Focus Detection</small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="d-flex align-items-center justify-content-center">
                    <i class="fas fa-search text-primary me-2"></i>
                    <small class="text-muted">Object Detection</small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="d-flex align-items-center justify-content-center">
                    <i class="fas fa-chart-line text-primary me-2"></i>
                    <small class="text-muted">Integrity Scoring</small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}